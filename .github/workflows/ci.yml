name: CI for Node.js Project (with Debug)

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–¥—É
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3Ô∏è‚É£ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
      - name: Install dependencies
        run: npm install

      # 4Ô∏è‚É£ –ë—ñ–ª–¥
      - name: Build project
        run: npm run build

      # 5Ô∏è‚É£ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –±—ñ–ª–¥—É
      - name: List files after build
        run: |
          echo "üìÅ –ü–æ—Ç–æ—á–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—ñ—Å–ª—è –±—ñ–ª–¥—É:"
          ls -la

      # 6Ô∏è‚É£ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±—ñ–ª–¥—É —è–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—É (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: |
            dist
            build

      # 7Ô∏è‚É£ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–º—ñ–Ω–Ω–∏—Ö —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
      - name: Debug environment variables
        run: |
          echo "üß© Debug info:"
          echo "EC2_HOST = $EC2_HOST"
          echo "EC2_USER = $EC2_USER"
          if [ -z "$EC2_HOST" ] || [ -z "$EC2_USER" ]; then
            echo "‚ùå EC2_HOST –∞–±–æ EC2_USER –Ω–µ –∑–∞–¥–∞–Ω—ñ!"
            exit 1
          fi

      # 8Ô∏è‚É£ –†–æ–∑—à–∏—Ñ—Ä–æ–≤–∫–∞ SSH-–∫–ª—é—á–∞
      - name: Decode SSH key
        run: |
          if [ -z "$EC2_SSH_KEY_B64" ]; then
            echo "‚ùå EC2_SSH_KEY_B64 –Ω–µ –∑–∞–¥–∞–Ω–æ!"
            exit 1
          fi
          echo "üîê –°—Ç–≤–æ—Ä—é—é SSH –∫–ª—é—á..."
          echo "$EC2_SSH_KEY_B64" | base64 --decode > my-ec2-key.pem
          chmod 600 my-ec2-key.pem
          echo "‚úÖ SSH –∫–ª—é—á —Å—Ç–≤–æ—Ä–µ–Ω–æ:"
          ls -lh my-ec2-key.pem

      # 9Ô∏è‚É£ –¢–µ—Å—Ç SSH-–∑‚Äô—î–¥–Ω–∞–Ω–Ω—è (–±–µ–∑ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥)
      - name: Test SSH connection
        run: |
          echo "üß† –ü–µ—Ä–µ–≤—ñ—Ä—è—é SSH-–∑'—î–¥–Ω–∞–Ω–Ω—è –∑ $EC2_USER@$EC2_HOST"
          ssh -i my-ec2-key.pem -o StrictHostKeyChecking=no -v $EC2_USER@$EC2_HOST "echo '‚úÖ SSH —É—Å–ø—ñ—à–Ω–æ –ø—ñ–¥–∫–ª—é—á–∏–≤—Å—è!'"

      # üîü –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –ø—Ä–æ—î–∫—Ç—É –Ω–∞ EC2
      - name: Copy project files to EC2
        run: |
          echo "üöÄ –ö–æ–ø—ñ—é—é —Ñ–∞–π–ª–∏ –Ω–∞ EC2..."
          scp -i my-ec2-key.pem -o StrictHostKeyChecking=no -r . $EC2_USER@$EC2_HOST:/home/$EC2_USER/app
          echo "‚úÖ –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"

      # 11Ô∏è‚É£ –ó–∞–ø—É—Å–∫ –∑–∞—Å—Ç–æ—Å—É–Ω–∫—É –Ω–∞ EC2
      - name: Run application on EC2
        run: |
          echo "üü¢ –ó–∞–ø—É—Å–∫–∞—é –∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫ –Ω–∞ EC2..."
          ssh -i my-ec2-key.pem -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "
            cd /home/$EC2_USER/app && \
            npm install && \
            nohup npm start > app.log 2>&1 &
          "
          echo "‚úÖ –ó–∞—Å—Ç–æ—Å—É–Ω–æ–∫ –∑–∞–ø—É—â–µ–Ω–æ!"

