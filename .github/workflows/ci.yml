name: CI for Node.js Project (EC2 Deploy)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}
      EC2_SSH_KEY_B64: ${{ secrets.EC2_SSH_KEY_B64 }}

    steps:
      # 1ï¸âƒ£ ÐšÐ»Ð¾Ð½ÑƒÐ²Ð°Ð½Ð½Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ñ–ÑŽ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3ï¸âƒ£ Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ð·Ð°Ð»ÐµÐ¶Ð½Ð¾ÑÑ‚ÐµÐ¹
      - name: Install dependencies
        run: npm install

      # 4ï¸âƒ£ Ð‘Ñ–Ð»Ð´ Ð¿Ñ€Ð¾Ñ”ÐºÑ‚Ñƒ
      - name: Build project
        run: npm run build

      # 5ï¸âƒ£ Ð›Ñ–ÑÑ‚Ð¸Ð½Ð³ Ñ„Ð°Ð¹Ð»Ñ–Ð² Ð¿Ñ–ÑÐ»Ñ Ð±Ñ–Ð»Ð´Ñƒ (debug)
      - name: List files after build
        run: ls -la

      # 6ï¸âƒ£ Debug environment
      - name: Debug environment
        run: |
          echo "EC2_HOST = $EC2_HOST"
          echo "EC2_USER = $EC2_USER"
          if [ -z "$EC2_HOST" ] || [ -z "$EC2_USER" ]; then
            echo "âŒ EC2_HOST Ð°Ð±Ð¾ EC2_USER Ð½Ðµ Ð·Ð°Ð´Ð°Ð½Ñ–!"
            exit 1
          fi

      # 7ï¸âƒ£ Ð Ð¾Ð·ÑˆÐ¸Ñ„Ñ€Ð¾Ð²ÐºÐ° SSH ÐºÐ»ÑŽÑ‡Ð°
      - name: Decode SSH key
        run: |
          echo "$EC2_SSH_KEY_B64" | base64 --decode > my-ec2-key.pem
          chmod 600 my-ec2-key.pem
          ls -lh my-ec2-key.pem

      # 8ï¸âƒ£ Ð¢ÐµÑÑ‚ SSH-Ð·â€™Ñ”Ð´Ð½Ð°Ð½Ð½Ñ
      - name: Test SSH connection
        run: |
          ssh -i my-ec2-key.pem -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "echo 'âœ… SSH Ð¿Ñ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ ÑƒÑÐ¿Ñ–ÑˆÐ½Ðµ'"

      # 9ï¸âƒ£ ÐšÐ¾Ð¿Ñ–ÑŽÐ²Ð°Ð½Ð½Ñ Ð¿Ñ€Ð¾Ñ”ÐºÑ‚Ñƒ Ð½Ð° EC2
      - name: Copy project to EC2
        run: |
          scp -i my-ec2-key.pem -o StrictHostKeyChecking=no -r . $EC2_USER@$EC2_HOST:/home/$EC2_USER/app

      # ðŸ”Ÿ Ð—Ð°Ð¿ÑƒÑÐº Ð·Ð°ÑÑ‚Ð¾ÑÑƒÐ½ÐºÑƒ Ð½Ð° EC2
      - name: Run application on EC2
        run: |
          ssh -i my-ec2-key.pem -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "
            cd /home/$EC2_USER/app && \
            npm install && \
            nohup npm start > app.log 2>&1 &
          "

